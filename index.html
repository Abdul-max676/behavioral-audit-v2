<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Behavioral Audit</title>
  <style>
  * {
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #f4f4f4;
    color: #111;
    margin: 0;
    padding: 30px 16px;
  }

  h1 {
    font-weight: 600;
    font-size: 22px;
    margin-bottom: 20px;
  }

  /* Input row */
  .input-row {
    display: flex;
    gap: 8px;
    margin-bottom: 25px;
  }

  input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
  }

  button {
    padding: 12px;
    border: none;
    border-radius: 8px;
    background: #111;
    color: white;
    font-size: 14px;
    cursor: pointer;
  }

  button:active {
    opacity: 0.8;
  }

  ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  li {
    background: white;
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 16px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
  }

  li strong {
    font-size: 16px;
  }

  .stats {
    font-size: 13px;
    margin: 8px 0 12px;
    color: #555;
  }

  .habit-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .habit-buttons button {
    flex: 1;
    background: #eaeaea;
    color: #111;
  }

  .habit-buttons button:first-child {
    background: #111;
    color: white;
  }

  .habit-buttons button:last-child {
    background: #dcdcdc;
  }

  #heatmap {
  margin-top: 20px;
}

.heatmap-grid {
  display: grid;
  grid-template-columns: repeat(14, 1fr);
  gap: 4px;
}

.heatmap-day {
  width: 100%;
  aspect-ratio: 1 / 1;
  border-radius: 4px;
  background: #eee;
}

  
  @media (min-width: 600px) {
    body {
      max-width: 600px;
      margin: 60px auto;
    }
  }
</style>
</head>
<body>

  <h1>Behavioral Audit</h1>
  <p id="dailyMessage"></p>
  <div id="weeklySummary"></div>
  <div id="disciplineScore"></div>
  <div id="heatmap"></div>
  <div class="input-row">
  <input id="habitInput" placeholder="Enter habit">
  <button onclick="addHabit()">Add</button>
  </div>


  <ul id="habitList"></ul>

  <script>
  let habits = JSON.parse(localStorage.getItem("habits")) || [];

  function saveHabits() {
    localStorage.setItem("habits", JSON.stringify(habits));
  }

  function todayString() {
    return new Date().toISOString().split("T")[0];
  }

  function calculateStreak(history) {
  if (!history || history.length === 0) {
    return { current: 0, longest: 0 };
  }

  // Sort newest first
  const sorted = [...history].sort((a, b) =>
    new Date(b.date) - new Date(a.date)
  );

  let currentStreak = 0;
  let longestStreak = 0;
  let tempStreak = 0;

  for (let i = 0; i < sorted.length; i++) {
    if (!sorted[i].done) {
      tempStreak = 0;
      continue;
    }

    tempStreak++;

    // Check if next entry is exactly 1 day older
    if (sorted[i + 1]) {
      const currentDate = new Date(sorted[i].date);
      const nextDate = new Date(sorted[i + 1].date);

      const diff =
        (currentDate - nextDate) / (1000 * 60 * 60 * 24);

      if (diff !== 1) {
        longestStreak = Math.max(longestStreak, tempStreak);
        tempStreak = 0;
      }
    }
  }

  longestStreak = Math.max(longestStreak, tempStreak);

  // Now calculate CURRENT streak (from today backwards)
  const today = todayString();
  const todayEntry = sorted.find(h => h.date === today);

  if (!todayEntry || !todayEntry.done) {
    currentStreak = 0;
  } else {
    currentStreak = 1;
    let prevDate = new Date(today);

    for (let i = 1; i < sorted.length; i++) {
      const entryDate = new Date(sorted[i].date);
      const diff =
        (prevDate - entryDate) / (1000 * 60 * 60 * 24);

      if (diff === 1 && sorted[i].done) {
        currentStreak++;
        prevDate = entryDate;
      } else {
        break;
      }
    }
  }

  return { current: currentStreak, longest: longestStreak };
}

  function updateDailyMessage() {
  const messageEl = document.getElementById("dailyMessage");

  const totalHabits = habits.length;
  const today = todayString();

  const completedToday = habits.filter(h => {
    const entry = (h.history || []).find(e => e.date === today);
    return entry && entry.done;
  }).length;

  if (totalHabits === 0) {
    messageEl.textContent = "No habits. No standards. Interesting.";
  } 
  else if (completedToday === totalHabits) {
    messageEl.textContent = "You did everything. Rare discipline.";
  } 
  else if (completedToday === 0) {
    messageEl.textContent = "Zero progress today. That’s a choice.";
  } 
  else {
    messageEl.textContent = 
      `${completedToday}/${totalHabits} done. You can do better.`;
  }
}

  window.debugSetDate = function(date) {
  todayString = () => date;
  renderHabits();
}

  function getWeekRange() {
  const today = new Date(todayString());
  const day = today.getDay(); // 0 = Sunday, 6 = Saturday

  // Make Saturday the end of the week
  const saturday = new Date(today);
  saturday.setDate(today.getDate() + (6 - day));

  const sunday = new Date(saturday);
  sunday.setDate(saturday.getDate() - 6);

  sunday.setHours(0,0,0,0);
  saturday.setHours(23,59,59,999);

  return { start: sunday, end: saturday };
}

  function calculateDisciplineScore() {
  let totalCompletions = 0;
  let totalLogs = 0;

  habits.forEach(habit => {
    const history = habit.history || [];
    totalLogs += history.length;
    totalCompletions += history.filter(h => h.done).length;
  });

  if (totalLogs === 0) return 0;

  return Math.round((totalCompletions / totalLogs) * 100);
}

  function generateHeatmapData(days = 90) {
  const data = {};

  habits.forEach(habit => {
    (habit.history || []).forEach(entry => {
      if (!data[entry.date]) {
        data[entry.date] = { done: 0, total: 0 };
      }

      data[entry.date].total++;
      if (entry.done) data[entry.date].done++;
    });
  });

  const today = new Date(todayString());
  const result = [];

  for (let i = days - 1; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(today.getDate() - i);
    const dateStr = date.toISOString().split("T")[0];

    const dayData = data[dateStr] || { done: 0, total: 0 };
    result.push({ date: dateStr, ...dayData });
  }

  return result;
}
  
    
  function renderHabits() {
  const list = document.getElementById("habitList");
  list.innerHTML = "";

  habits.forEach((habit, index) => {
    autoMissIfSkipped(habit);
    const li = document.createElement("li");
    const history = habit.history || [];
    const streak = calculateStreak(history);
    const total = history.length;
    const completed = history.filter(h => h.done).length;
    const missed = total - completed;

    li.innerHTML = `
      <strong>${habit.name}</strong>
      <div class="stats">
        Completed: ${completed} | Missed: ${missed}<br>
        Current Streak: ${streak.current} | Longest: ${streak.longest}
      </div>
    `;

    const completeBtn = document.createElement("button");
    completeBtn.textContent = "Mark Complete";
    completeBtn.onclick = () => markHabit(index, true);

    const missBtn = document.createElement("button");
    missBtn.textContent = "Mark Missed";
    missBtn.onclick = () => markHabit(index, false);

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete";
    deleteBtn.onclick = () => {
      habits.splice(index, 1);
      saveHabits();
      renderHabits();
    };

    const buttonGroup = document.createElement("div");
    buttonGroup.className = "habit-buttons";

    buttonGroup.appendChild(completeBtn);
    buttonGroup.appendChild(missBtn);
    buttonGroup.appendChild(deleteBtn);

    li.appendChild(buttonGroup);
    
    list.appendChild(li);
    });
    updateDailyMessage();
    updateWeeklySummary();
    updateDisciplineScore();
    updateHeatmap();

  }

  function updateDisciplineScore() {
  const scoreEl = document.getElementById("disciplineScore");
  const score = calculateDisciplineScore();

  let label = "";

  if (score >= 85) label = "Elite consistency.";
  else if (score >= 70) label = "Solid discipline.";
  else if (score >= 50) label = "Unreliable effort.";
  else if (score > 0) label = "Chaotic behavior.";
  else label = "No data.";

  scoreEl.innerHTML = `
    <div class="stats">
      <strong>Discipline Score</strong><br>
      ${score}%<br>
      ${label}
    </div>
  `;
}

  
    
  function getWeeklySummary() {
  const { start, end } = getWeekRange();

  let totalCompletions = 0;
  let totalMisses = 0;
  let bestHabit = null;
  let bestRate = 0;

  habits.forEach(habit => {
    const weekEntries = (habit.history || []).filter(entry => {
      const entryDate = new Date(entry.date);
      entryDate.setHours(0,0,0,0);
    });

    const completed = weekEntries.filter(e => e.done).length;
    const missed = weekEntries.length - completed;

    totalCompletions += completed;
    totalMisses += missed;

    const possible = weekEntries.length;
    const rate = possible > 0 ? completed / possible : 0;

    if (rate > bestRate && possible > 0) {
      bestRate = rate;
      bestHabit = habit.name;
    }
  });

  const totalLogs = totalCompletions + totalMisses;
  const completionRate =
    totalLogs > 0
      ? Math.round((totalCompletions / totalLogs) * 100)
      : 0;

  return {
    totalCompletions,
    totalMisses,
    completionRate,
    bestHabit
  };
}


  function updateHeatmap() {
  const container = document.getElementById("heatmap");
  const data = generateHeatmapData();

  container.innerHTML = `
    <div class="stats"><strong>Consistency Heatmap</strong></div>
    <div class="heatmap-grid"></div>
  `;

  const grid = container.querySelector(".heatmap-grid");

  data.forEach(day => {
    const square = document.createElement("div");
    square.className = "heatmap-day";

    if (day.total === 0) {
      square.style.background = "#eee";
    } else {
      const rate = day.done / day.total;

      if (rate === 1) square.style.background = "#0f9d58";
      else if (rate >= 0.5) square.style.background = "#34c759";
      else if (rate > 0) square.style.background = "#ffcc00";
      else square.style.background = "#ff3b30";
    }

    square.title = `${day.date} — ${day.done}/${day.total}`;
    grid.appendChild(square);
  });
}

  
  function updateWeeklySummary() {
  const summaryEl = document.getElementById("weeklySummary");
  const today = new Date(todayString());

  if (today.getDay() !== 6) {
    summaryEl.innerHTML = "";
    return;
  }

  const summary = getWeeklySummary();

  summaryEl.innerHTML = `
    <div class="stats">
      <strong>Weekly Review</strong><br>
      Total Completions: ${summary.totalCompletions}<br>
      Total Misses: ${summary.totalMisses}<br>
      Completion Rate: ${summary.completionRate}%<br>
      Best Habit: ${summary.bestHabit || "None"}
    </div>
  `;
}

    
  function autoMissIfSkipped(habit) {
  const history = habit.history || [];
  if (history.length === 0) return;

  const sorted = [...history].sort((a, b) =>
    new Date(b.date) - new Date(a.date)
  );

  const lastDate = new Date(sorted[0].date);
  const today = new Date(todayString());

  const diffDays =
    Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));

  if (diffDays > 1) {
    for (let i = 1; i < diffDays; i++) {
      const missedDate = new Date(lastDate);
      missedDate.setDate(lastDate.getDate() + i);

      habit.history.push({
        date: missedDate.toISOString().split("T")[0],
        done: false
      });
    }

    saveHabits();
  }
}

    
  function addHabit() {
    const input = document.getElementById("habitInput");
    const value = input.value.trim();
    if (!value) return;

    habits.push({
      name: value,
      history: []
    });

    saveHabits();
    renderHabits();
    input.value = "";
  }

  function markHabit(index, doneStatus) {
    const today = todayString();
    const habit = habits[index];

    // Prevent double logging for same day
    const history = habit.history || [];
    const alreadyLogged = history.find(h => h.date === today);
    if (alreadyLogged) {
      alert("Already logged for today.");
      return;
    }

    habit.history.push({
      date: today,
      done: doneStatus
    });

      saveHabits();
      renderHabits();
}

    renderHabits();

</script>


</body>
</html>
